# 미국주식 매도 시뮬레이터 분석 보고서

## 1. 문서 요약 및 10줄평

### 핵심 목적

기존 **매수/매도/포지션 엔진** 위에 **미국주식 양도세 절세 전략 엔진 + 리포트 시스템**을 추가하는 것.

### 주요 전제 조건

* **과세 대상:** 실현 이익(Realized Gain)만 — 평가손익은 제외
* **비과세 한도:** 연 250만원 (해당 연도 실현이익 합계 기준)
* **통화 기준:** 모든 세금 계산은 **KRW** 기준 (거래일 환율 적용)
* **원가 계산:** 평균단가(Average Cost) 방식
* **설정값 분리:** 세율(22%), 비과세 한도(250만원)는 `TAX_CONFIG`로 별도 관리

### 핵심 기능 모듈

1. **연도별 실현이익 계산 엔진:** `calculateRealizedGainByYear(trades)`
2. **절세 전략 3가지:**
    * **전략 1:** 연 250만원 비과세 한도 내 매도 추천
    * **전략 2:** 사용자 선택 종목 시뮬레이션
    * **전략 3:** 목표 매도금액 기반 최적 조합 추천
3. **PDF 보고서 출력:** 요약, 전략 분석, 세액 비교 등

### 10줄평

1. **명확한 도메인 설계:** 세금 계산의 핵심 전제(실현이익, 연도별 한도, KRW 기준)를 명확히 하여 혼동 방지.
2. **실용적인 절세 알고리즘:** Tax-loss Harvesting, Greedy 조합 등 현실적인 절세 전략 로직화.
3. **확장 가능한 설정 구조:** `TAX_CONFIG`로 세법 변경 시 유연한 대응 가능.
4. **세 가지 전략의 명확한 분리:** 한도 내 추천 / 사용자 선택 / 목표금액 조합 등 유즈케이스별 정리.
5. **KRW 환산 로직의 일관성:** 거래별 환율(`fxRate`) 적용으로 실무 적합성 확보.
6. **PDF 보고서 설계 포함:** 계산 엔진을 넘어 최종 산출물까지 고려한 완성도 높은 설계.
7. **부분 매도(Partial Sell) 지원:** Greedy 알고리즘에 부분 매도 로직을 자연스럽게 통합.
8. **안전 여유값(safetyMargin) 적용:** 한도 초과 리스크 관리를 위한 보수적 옵션 제공.
9. **모듈 분리 원칙 준수:** 엔진 / 전략 / 출력 로직의 명확한 분리로 유지보수성 확보.
10. **기존 시스템 통합 고려:** 기존 테이블 구조 위에 얹을 수 있는 높은 확장성.

---

## 2. 추가 상세 분석 (Gap Analysis)

### 🚨 1. 데이터 정합성 리스크 (Critical)

* **문제점:** 현재 `AssetRecord`의 `exchangeRate` 필드가 선택적(Optional)이며, 미입력 시 `0`으로 저장됨. `AssetFormModal` 및 CSV 가져오기에서도 강제성이 없음.
* **영향:** 세금 계산 시 **매수 원가(Cost Basis)가 0원**으로 계산될 위험. 이는 '매도금액 전액 = 이익'으로 오인되어 양도세가 과다 산출되는 결과를 초래함.
* **해결 방안:** 미국주식 데이터 입력/수정 시 `exchangeRate > 0` 유효성 검사 필수화 및 기존 데이터 일괄 보정 필요.

### 📉 2. 알고리즘 & 로직 적합성

* **현행 (`AssetConfig`):** 포트폴리오 가치 산정 시 '현재 환율'만 전역 적용 (평가액 관점).
* **시뮬레이터:** 각 거래 시점의 '역사적 환율(Historical FX)' 개별 적용 필요 (세금 관점). 문서의 `calculateRealizedGainByYear` 로직이 이에 부합함.
* **엣지 케이스:** 부분 매도(Partial Sell) 시, DB 변경 없이 이벤트 소싱 방식으로 가상 메모리 상에서만 로직이 수행되도록 구현해야 함.

### 🎨 3. UX/UI 추천 방향

1. **데이터 건전성 체크:** 시뮬레이터 진입 시 환율 정보 누락 거래 감지 및 경고 표시.
2. **Actionable Insight:** 시뮬레이션 결과로 나온 매도 추천안을 **[이대로 매도 기록 생성]** 버튼을 통해 즉시 반영할 수 있는 기능 제공.

---

## 3. 단계별 구현 로드맵

### Step 1: 데이터 무결성 확보 (선결 과제)

* `AssetFormModal`에서 미국주식 거래 시 환율 입력 필수화.
* 기존 데이터 중 환율이 0인 항목을 찾아 수정하는 '데이터 보정' 기능 구현.

### Step 2: 핵심 엔진 구현

* `usTaxEngine.ts` 작성: 연도별 실현이익 계산 로직 및 단위 테스트.

### Step 3: 시뮬레이터 UI 및 리포트

* 내 비과세 한도 조회 대시보드 구현.
* 절세 전략 시뮬레이션 실행 및 PDF 리포트 출력 기능 구현.
